@Test
@Tag("FheSafeSerialization")
void safeSerialization() {
  logger.trace("safeSerialization");

  {{testValue tested}}
  {{tested.className}} encrypted = {{tested.className}}.encrypt(originalValue, keySet.clientKey());
  byte[] serialized = encrypted.serializeSafely();
  {{tested.className}} deserialized = {{tested.className}}.deserializeSafely(serialized, keySet.serverKey());
  {{#if tested.compressed}}
    {{tested.compressed.className}} decompressedDeserialized = deserialized.decompress();
    {{tested.dataClass.simpleName}} decrypted = decompressedDeserialized.decrypt(keySet.clientKey());
  {{else}}
    {{tested.dataClass.simpleName}} decrypted = deserialized.decrypt(keySet.clientKey());
  {{/if}}

  assertThat(decrypted).isEqualTo(originalValue);
}
